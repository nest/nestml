name: Benchmark Publisher

on:
  workflow_run:
    workflows: ["Benchmark Runner"]
    types: [completed]

jobs:
  publish:
    name: Publish Benchmark Results
    runs-on: ubuntu-latest
    # Only run if the previous unprivileged run was successful
    if: github.event.workflow_run.conclusion == 'success'

    # Required permissions to comment on PRs and push to gh-pages
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      # Download the JSON results from the unprivileged workflow
      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Publish using the downloaded JSON
      - name: Progress benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'pytest'
          output-file-path: results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-comment-insert-mode: append
          fail-on-alert: true
          comment-on-alert: true
          auto-push: true
          alert-threshold: '120%'

