{#
  Generates a series of C statements which perform one integration step of
  all odes defined the neuron.
#}
{%- if tracing %}/* generated by {{self._TemplateReference__context.name}} */ {% endif %}
// numerical integration with fixed step size, either rk4 or forward euler:
// ------------------------------------------------------
        REAL y_old[{{ numeric_state_variables_to_be_integrated | length }}];
    {%- for state_variable in numeric_state_variables_to_be_integrated %}
        y_old[{{ loop.index0 }}] = {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }};
    {%- endfor %}
        REAL y_new[{{ numeric_state_variables_to_be_integrated | length }}];
{%- if numeric_solver == "rk45" %}
        rk4_step({{ neuronName }}{% if ast.get_args() | length > 0 %}_{{ utils.integrate_odes_args_str_from_function_call(ast) }}_{% endif %}rhs, (REAL)systicks, y_old,
                           global_neuron_params.calc_step_raw, {{ numeric_state_variables_to_be_integrated |length }}, neuron, y_new);
{%- for state_variable in numeric_state_variables_to_be_integrated %}
    {% set result = utils.check_if_statevar_depends_on_spikes(state_variable, neuron) %}
    {%- if result == ["exc_spikes"] %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}] + {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_EX;
    {%- elif result == ["inh_spikes"] %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}] + {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_IN;
    {%- elif result == ["exc_spikes", "inh_spikes"] %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}] + {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_EX - {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_IN;
    {%- else %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}];
    {%- endif %}
{%- endfor %}


{%- elif numeric_solver == "forward-Euler" %}
        forward_euler_step({{ neuronName }}{% if ast.get_args() | length > 0 %}_{{ utils.integrate_odes_args_str_from_function_call(ast) }}_{% endif %}rhs, (REAL)systicks, y_old,
                           global_neuron_params.calc_step_raw, {{ numeric_state_variables_to_be_integrated |length }}, neuron, y_new);
{%- for state_variable in numeric_state_variables_to_be_integrated %}
    {% set result = utils.check_if_statevar_depends_on_spikes(state_variable, neuron) %}
    {%- if result == ["exc_spikes"] %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}] + {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_EX;
    {%- elif result == ["inh_spikes"] %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}] + {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_IN;
    {%- elif result == ["exc_spikes", "inh_spikes"] %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}] + {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_EX - {{ printer_no_origin.print(utils.get_variable_by_name(neuron, state_variable)) }}_IN;
    {%- else %}
    {{ printer.print(utils.get_variable_by_name(neuron, state_variable)) }} = y_new[{{ loop.index0 }}];
    {%- endif %}
{%- endfor %}
{%- else %}
{{ raise('Unknown numeric ODE solver requested.') }}
{%- endif %}
