#include "rk4.h"

void rk4_step(
    ode_rhs_f f,
    REAL t,
    const REAL *y,
    REAL h,
    uint8_t dim,
    const void *neuron_params,
    REAL *y_out)
{
    REAL k1[dim], k2[dim];
    REAL k3[dim], k4[dim];
    REAL y_temp[dim];

    /* k1 */
    f(t, y, k1, dim, neuron_params);

    /* k2 */
    for (uint8_t i = 0; i < dim; ++i)
        y_temp[i] = y[i] + 0.5f * h * k1[i];
    f(t + 0.5f * h, y_temp, k2, dim, neuron_params);

    /* k3 */
    for (uint8_t i = 0; i < dim; ++i)
        y_temp[i] = y[i] + 0.5f * h * k2[i];
    f(t + 0.5f * h, y_temp, k3, dim, neuron_params);

    /* k4 */
    for (uint8_t i = 0; i < dim; ++i)
        y_temp[i] = y[i] + h * k3[i];
    f(t + h, y_temp, k4, dim, neuron_params);

    /* combine */
    for (uint8_t i = 0; i < dim; ++i)
    {
        y_out[i] = y[i] + h * (k1[i] + 2.0f * k2[i] + 2.0f * k3[i] + k4[i]) / 6.0f;
    }
}
